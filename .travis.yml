language: php
sudo: false

services:
- docker

php:
- '7.0'
- '7.1'
- '7.2'

env:
  global:
  - secure: e1qU2CrWtzh1Anm/Gmtpb2ESFaeuswBrvkuJJ8aBkhCvT35/0ZuzTcL4/l2OGFd3CFxEYShkAm/hjhcj+n/w6TM/OQL+GbLY+hEk1DaXO9tTtwTMpJ3slufgW2z2uxAtVIyzVPrHpRpN8gR5QvEvYQ7qHrd+iTSXLTk7/6v8+alm845Y8ylzCb9Iaj2EhkdjWZHXjPxKivi8dmw6tRbz4D9nrP5ZpW6YFVSC6CjxzAuFJTRs2duWMKusGnRDhIGG8yFOK4TD/THhTOIT5ZDhIM+2SMcS7NkEiFQZw8bTquWI8GBS9m9UBQY66d+yJxKjUc/x7yRSX/8o3GstHgNGwJV8bYTdW1X1uw9ZSaJDoVlqCqdqme6i0/0xR5m74JqczI0fXRz48IfDhs7y0d8FGtju5PhyJd5CqmkM0Buhi3U5Fk0DXaNN5IVvUGOAuynbfkQR7nbSz7ASgw0lRj1ZpgDSaZRZZOd8T1vg1USj5/wBmWpMuDnSNByFdWKJIG2A+ctwQbz8Jqoi7/D7cWC3gcR6h8aY2zEFIt+1c4i4ysnDLMEem3bSMpGwkq2qu9yox3U4Nt9pFOQdpKdujtGGKhDVtRdtJo9cpobgsaRHW8cp+HLsag7sESrhcmAOa24JXrw4V9BmD+TwJhroGlb/IdeZ1sJt5wMR7596B1anRGs=
  - secure: P1ZzI1NnFwgUBkCBOAcYzWfuq93Y4os2d0xhP5Zy/Zz/37dZbaXl3TvLc0zjmrd3aQdWpjzcnPZBDLTEH7j6UkPCrkJA34t/sOR02jNiPvnFsexcGMiMdg5l++hNJHwT1f+3bnxYwoxZ5Ah7xNQu6aB7y+51LohIM4QZBmJvVN+x8TrXdXwM3agZmME8ocPJgWfZfkBMc50NCTm1k9kuKUh6tAJCHme0smyV7cJBRfJ+svdvcna8874TcbTPsoTV5pmH1C5RIRpIB88C3E6qeZe37JlExfWI66PrAmjlDB5zp1zYDBUf1fwdmw5MuW3BMuFywj9OkakZyT0vesnWdaUj38WLGJoIZG2oGDJj7YqhLuzMCncMGWz1OLJSinEVifTzewXPITiUJeIueycbqkr5RJ9Qv/nM9Aucm8V82414Lhh9Ttuinf1J/8LlTeookpRPo/rbDwfvSPtRxbhSufXhhkPgxTQTyCBAgLup72yjjOGZl+g2p1zg3aA6pqsSAQYXp0OKlyp9lKlqPxYSoAj8RsQHkyZGb/7V9YqIHBZx+XdpbRdNMdMtxfAjG3SfN7ffHwLJDS4dal0H/s96eeLxRS5wrpE4hKf5pz7MqdKgzpduh/W+TSotudbXCD1y9U7V7tjqADw/QpCM3Dg3GR1joeR13GG+IEEy4Q1Pm4k=

before_install:
- git fetch --unshallow || true # Travis might do a shallow clone, but GitVersion needs the full history including branches and tags
- git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
- git fetch origin
- git branch master origin/master || true # GitVersion seems to require a local "master" branch these days. That's a bug, but oh well.
- if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then git checkout -b "$TRAVIS_PULL_REQUEST_BRANCH-pr"; fi # Create an explicit branch on pull requests as I'm unable to pass Git_Branch into the Docker container for some
- git log --graph --format="%h %cr %d" --decorate --date=relative --all --remotes="*" -n 100

install:
- wget https://raw.githubusercontent.com/magento/marketplace-tools/master/validate_m2_package.php
- export GITVERSION="gittools/gitversion:5.0.0-linux-debian-9-netcoreapp2.2"
- docker pull $GITVERSION

before_script:
- docker run --rm --volume "$(pwd):/repo" $GITVERSION /repo -output json > GitVersion.json
- cat GitVersion.json
- export SEMVER=$(jq -r '.FullSemVer' GitVersion.json)
- export PRE_RELEASE_LABEL=$(if [ $(jq '.PreReleaseLabel' GitVersion.json) != '""' ]; then echo '-dev'; fi)
- export COMPOSER_VERSION="$(jq -r ".MajorMinorPatch" GitVersion.json)$PRE_RELEASE_LABEL$(jq -r ".CommitsSinceVersionSourcePadded" GitVersion.json)"
- export ARCHIVE=${TRAVIS_REPO_SLUG#SwedbankPay/}-${SEMVER}.zip
- echo $ARCHIVE
- jq ".version=\"$COMPOSER_VERSION\"" composer.json > composer.version.json # Add "version" property to composer.version.json
- mv composer.json composer.clean.json
- mv composer.version.json composer.json # Rename composer.version.json to composer.json
- zip -r $ARCHIVE *
- zip -d $ARCHIVE validate_m2_package.php
- rm composer.json
- mv composer.clean.json composer.json # Move the version-less composer.json back in place so `composer validate` won't react on it in the script section.

script:
- php validate_m2_package.php -d $ARCHIVE
- rm validate_m2_package.php
- |
  cat << EOF > auth.json
  {
    "http-basic": {
      "repo.magento.com": {
        "username": "$MAGENTO_PUBLIC_KEY",
        "password": "$MAGENTO_PRIVATE_KEY"
      }
    }
  }
  EOF
- composer validate
- composer install
- ./vendor/bin/phpcs --standard=Magento2 --report=full --ignore=vendor/* .

deploy:
  provider: releases
  api_key:
    secure: T31P9eRFFU1fH1dGyqd2gOvvW6Ln3+eepe1hPjGaig+YLkiQxY20DYowyiiMkl12HnMFdqby3EjZ4QjJ3N62Ym9m19tdnuniVLEUFF+lHhrThPRX6wtecNFkgSWLD6V4gptkBuoXWcKW67qzcISFgHt/RA799Ic9BFNXCjyZcuziFSRVHtrs2MUaf8mRzseynZgrRFnzMJjXqeiFbg6Dexh4Fqb9p15UouGbFk7c8dnwo7ruc68jmCnZ71Dz+YxDiMYpCbCwZJx5eTl4RlO39Bj9hlVh+UlMiHazRK3uQquWEzbqxhlPA6JLF2hHmiiMrOiVdMZ9bQ4f9PDO7HcWi0Op6kleaBJ6yX7GPItSPn3jXpeqs4AKjlRtxP1pCVHZ/w9GPYjbJ/Hp2wx2logHjrqSmoh0ZAJlS0RBPb/ojQa/uu1J2hj4ycQP3BnxtTiJyPvfiG6l6fx4t0jE26ubQ2yiBbg9lSxogqBkF12M5n579gXHUUaeX5t6uYFnivC5ay1P0v37YiT/E9G/gT/k4GLG4o655Tggq6k9nHiB2lrchzH2dIc2x4IvIKK7TJ7z1bXIu2ICW1aUWnWoP7t1Pp8zsGNYeaHc5OftPIYEnpfETYSg5U1J1ioDxXb28OxMmAPRTIlH2KOi+0s2KpNnB03zqAe/W7Ag+kzi5Vwlxng=
  file: "$ARCHIVE"
  overwrite: true
  skip_cleanup: true
  on:
    tags: true
