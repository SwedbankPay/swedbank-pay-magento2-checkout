language: php
os: linux
dist: xenial

services:
- docker

php:
- '7.0'
- '7.1'
- '7.2'

env:
  global:
  - secure: e1qU2CrWtzh1Anm/Gmtpb2ESFaeuswBrvkuJJ8aBkhCvT35/0ZuzTcL4/l2OGFd3CFxEYShkAm/hjhcj+n/w6TM/OQL+GbLY+hEk1DaXO9tTtwTMpJ3slufgW2z2uxAtVIyzVPrHpRpN8gR5QvEvYQ7qHrd+iTSXLTk7/6v8+alm845Y8ylzCb9Iaj2EhkdjWZHXjPxKivi8dmw6tRbz4D9nrP5ZpW6YFVSC6CjxzAuFJTRs2duWMKusGnRDhIGG8yFOK4TD/THhTOIT5ZDhIM+2SMcS7NkEiFQZw8bTquWI8GBS9m9UBQY66d+yJxKjUc/x7yRSX/8o3GstHgNGwJV8bYTdW1X1uw9ZSaJDoVlqCqdqme6i0/0xR5m74JqczI0fXRz48IfDhs7y0d8FGtju5PhyJd5CqmkM0Buhi3U5Fk0DXaNN5IVvUGOAuynbfkQR7nbSz7ASgw0lRj1ZpgDSaZRZZOd8T1vg1USj5/wBmWpMuDnSNByFdWKJIG2A+ctwQbz8Jqoi7/D7cWC3gcR6h8aY2zEFIt+1c4i4ysnDLMEem3bSMpGwkq2qu9yox3U4Nt9pFOQdpKdujtGGKhDVtRdtJo9cpobgsaRHW8cp+HLsag7sESrhcmAOa24JXrw4V9BmD+TwJhroGlb/IdeZ1sJt5wMR7596B1anRGs=
  - secure: P1ZzI1NnFwgUBkCBOAcYzWfuq93Y4os2d0xhP5Zy/Zz/37dZbaXl3TvLc0zjmrd3aQdWpjzcnPZBDLTEH7j6UkPCrkJA34t/sOR02jNiPvnFsexcGMiMdg5l++hNJHwT1f+3bnxYwoxZ5Ah7xNQu6aB7y+51LohIM4QZBmJvVN+x8TrXdXwM3agZmME8ocPJgWfZfkBMc50NCTm1k9kuKUh6tAJCHme0smyV7cJBRfJ+svdvcna8874TcbTPsoTV5pmH1C5RIRpIB88C3E6qeZe37JlExfWI66PrAmjlDB5zp1zYDBUf1fwdmw5MuW3BMuFywj9OkakZyT0vesnWdaUj38WLGJoIZG2oGDJj7YqhLuzMCncMGWz1OLJSinEVifTzewXPITiUJeIueycbqkr5RJ9Qv/nM9Aucm8V82414Lhh9Ttuinf1J/8LlTeookpRPo/rbDwfvSPtRxbhSufXhhkPgxTQTyCBAgLup72yjjOGZl+g2p1zg3aA6pqsSAQYXp0OKlyp9lKlqPxYSoAj8RsQHkyZGb/7V9YqIHBZx+XdpbRdNMdMtxfAjG3SfN7ffHwLJDS4dal0H/s96eeLxRS5wrpE4hKf5pz7MqdKgzpduh/W+TSotudbXCD1y9U7V7tjqADw/QpCM3Dg3GR1joeR13GG+IEEy4Q1Pm4k=

before_install:
- git fetch --unshallow || true # Travis might do a shallow clone, but GitVersion needs the full history including branches and tags
- git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
- git fetch origin
- git branch master origin/master || true # GitVersion seems to require a local "master" branch these days. That's a bug, but oh well.
- if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then git checkout -b "$TRAVIS_PULL_REQUEST_BRANCH-pr"; fi # Create an explicit branch on pull requests as I'm unable to pass Git_Branch into the Docker container for some
- git log --graph --format="%h %cr %d" --decorate --date=relative --all --remotes="*" -n 100

install:
- export GITVERSION="gittools/gitversion:5.0.0-linux-debian-9-netcoreapp2.2"
- docker pull $GITVERSION

before_script:
- docker run --rm --volume "$(pwd):/repo" $GITVERSION /repo -output json > GitVersion.json
- cat GitVersion.json
- export SEMVER=$(jq -r '.FullSemVer' GitVersion.json)
- export MAJOR_MINOR_PATCH=$(jq -r ".MajorMinorPatch" GitVersion.json)
- if [ -z "$TRAVIS_TAG" ]; then
    export PRE_RELEASE_LABEL='-dev';
    export COMMIT_COUNT=$(jq -r ".CommitsSinceVersionSourcePadded" GitVersion.json);
  fi
- export COMPOSER_VERSION="$MAJOR_MINOR_PATCH$PRE_RELEASE_LABEL$COMMIT_COUNT"
- export ARCHIVE=${TRAVIS_REPO_SLUG#SwedbankPay/}-${SEMVER}.zip
- echo $ARCHIVE
- jq ".version=\"$COMPOSER_VERSION\"" composer.json > composer.version.json # Add "version" property to composer.version.json
- mv composer.json composer.clean.json
- mv composer.version.json composer.json # Rename composer.version.json to composer.json
- zip -r $ARCHIVE *
- zip -d $ARCHIVE validate_m2_package.php
- rm composer.json
- mv composer.clean.json composer.json # Move the version-less composer.json back in place so `composer validate` won't react on it in the script section.

script:
- php ./vendor/validate_m2_package.php -d $ARCHIVE
- |
  cat << EOF > auth.json
  {
    "http-basic": {
      "repo.magento.com": {
        "username": "$MAGENTO_PUBLIC_KEY",
        "password": "$MAGENTO_PRIVATE_KEY"
      }
    }
  }
  EOF
- composer validate
- composer install
- ./vendor/bin/phpcs --standard=Magento2 --report=code --ignore=vendor/* --runtime-set ignore_warnings_on_exit true .

deploy:
  provider: releases
  token:
    secure: fRr01CZzUK+vRP0zCoy63dvdZMH+EnOzDE2J4JGfU20EbH40vODjd5EOPDjlQ/1483NTt+9NDKVqhLFO/ED+iQoyOQnqPm7hU8mmN5pNjInRZrHP3gWYox3U97MLPivLzAPvcgYuDu6pfUqd6YymSMMur/KOUe+mb+7jdG9FpUTeNSxCkvfVX9O1DQx+NV/bUI5EXW5fG9zRygygMwEVQgj/kELArDz50Nnpghm3g0mzPFxXy7G0KwoNM1PvpBava1SbWVvHNsdLfrWj9j9UNHiJ7+m3N+t5AnK+AjSlcoVVmTC/DiKI0YwG+GiYfDDPQ3+0VmpThX97rCdbA7y15hWnLcicuj+47o7kWKyI1Q2ry+/oAvYigELCLiAL1QCf052k8gFp4xipI8+jXuALNdGTpDdfxr22b0ZtMvTHeY8W1zhG92o8Uyz+/qbI9YkB74zElYtQZ+LXne/mD7CiZitXTUnwSIwqd8X2V3l0/yOgsuvygtDOZIzWX09ic/EZq61olMh+uBjctV+3twvbcRf1+vxXziGiM+E5e4khucN9gnihxJ9edkFOx8HpMmKV0++gjwaKObus0uTxbtL3Vs8GAHMMojF1HPwWpbBZd8KEdty/cHMbB41A8QNcTsG2pZ5b/pcytXgu0mEzcGZ+LC2SJCvXbA1YXC09jLKwbys=
  file: "$ARCHIVE"
  overwrite: true
  on:
    tags: true
